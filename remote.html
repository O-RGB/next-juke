<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>NextJuke Remote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
      body {
        background-color: #000;
        color: white;
        -webkit-tap-highlight-color: transparent;
      }
      .hidden {
        display: none !important;
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .glass-panel {
        background: rgba(24, 24, 27, 0.6);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      /* Safe Area Utilities */
      .pt-safe {
        padding-top: env(safe-area-inset-top);
      }
      .pb-safe {
        padding-bottom: env(safe-area-inset-bottom);
      }
    </style>
  </head>
  <body class="flex flex-col h-screen overflow-hidden font-sans bg-black">
    <div
      id="toast"
      class="fixed top-20 left-1/2 -translate-x-1/2 z-50 bg-zinc-800 border border-zinc-700 text-white px-4 py-2 rounded-full shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none text-sm font-bold flex items-center gap-2 whitespace-nowrap pt-safe"
    >
      <i class="fa-solid fa-check text-green-500"></i>
      <span id="toast-msg">Success</span>
    </div>

    <div
      id="login-screen"
      class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-6"
    >
      <div
        class="w-full max-w-sm glass-panel p-8 rounded-3xl text-center space-y-6"
      >
        <h1 class="text-2xl font-bold text-white">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ</h1>
        <input
          id="username-input"
          type="text"
          placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
          class="w-full bg-zinc-900 border border-zinc-700 p-4 rounded-xl text-center text-white outline-none focus:border-zinc-500 transition-colors"
        />
        <button
          onclick="handleJoin()"
          class="w-full bg-zinc-100 text-black p-4 rounded-xl font-bold shadow-lg active:scale-95 transition-transform"
        >
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á
        </button>
        <p id="error-msg" class="text-red-500 text-xs"></p>
      </div>
    </div>

    <div id="remote-ui" class="flex-1 flex flex-col hidden">
      <div
        class="shrink-0 p-4 pt-safe flex justify-between items-center glass-panel border-b-0 border-white/5 bg-zinc-900/50"
      >
        <div class="flex items-center gap-3">
          <div
            id="user-avatar"
            class="w-10 h-10 rounded-full bg-zinc-800 flex items-center justify-center font-bold text-lg border border-white/10 text-gray-400"
          >
            ?
          </div>
          <div>
            <div
              id="user-name"
              class="font-bold text-sm leading-tight text-white"
            >
              -
            </div>
            <div
              id="user-role"
              class="text-[10px] text-gray-500 font-mono uppercase"
            >
              ‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô
            </div>
          </div>
        </div>
        <div
          id="status-badge"
          class="text-[10px] px-2 py-1 rounded-full border bg-zinc-800 border-zinc-700 text-gray-400"
        >
          Connecting...
        </div>
      </div>

      <div class="flex-1 flex flex-col p-4 gap-4 overflow-y-auto">
        <div class="glass-panel p-4 rounded-2xl space-y-3">
          <div
            class="flex items-center gap-2 text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            <i class="fa-brands fa-youtube text-red-500 text-lg"></i> ‡∏Ç‡∏≠‡πÄ‡∏û‡∏•‡∏á
            (YouTube)
          </div>
          <div class="flex gap-2">
            <input
              id="url-input"
              type="text"
              placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
              class="flex-1 bg-zinc-900 border border-zinc-700 rounded-xl px-4 py-3 text-sm focus:border-pink-500 outline-none transition-colors"
            />
            <button
              onclick="addSong()"
              id="add-btn"
              class="w-12 flex items-center justify-center rounded-xl bg-zinc-800 border border-zinc-700 text-gray-500 transition-colors"
              disabled
            >
              <i class="fa-solid fa-plus"></i>
            </button>
          </div>

          <div
            id="preview-box"
            class="flex gap-3 bg-zinc-900/50 p-2 rounded-lg border border-white/5 hidden fade-in"
          >
            <img
              id="prev-img"
              src=""
              class="w-16 h-12 object-cover rounded bg-zinc-800"
            />
            <div class="flex-1 min-w-0 flex flex-col justify-center">
              <p
                id="prev-title"
                class="text-xs font-bold truncate text-white"
              ></p>
              <p class="text-[10px] text-gray-500">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏¥‡∏ß</p>
            </div>
          </div>
        </div>

        <div id="master-controls" class="hidden grid grid-cols-4 gap-3 fade-in">
           <button
            onclick="sendAction('SEEK', {amount: -5})"
            class="bg-zinc-800 hover:bg-zinc-700 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-zinc-700"
          >
             <i class="fa-solid fa-rotate-left text-gray-400"></i>
             <span class="text-[10px] font-bold text-gray-500">-5s</span>
          </button>
          
          <button
            onclick="sendAction('PLAY')"
            class="bg-zinc-800 hover:bg-zinc-700 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-zinc-700"
          >
            <i class="fa-solid fa-play text-green-500 text-lg"></i>
          </button>
          
          <button
            onclick="sendAction('PAUSE')"
            class="bg-zinc-800 hover:bg-zinc-700 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-zinc-700"
          >
            <i class="fa-solid fa-pause text-yellow-500 text-lg"></i>
          </button>

           <button
            onclick="sendAction('SEEK', {amount: 5})"
            class="bg-zinc-800 hover:bg-zinc-700 p-4 rounded-2xl flex flex-col items-center justify-center gap-1 transition active:scale-95 border border-zinc-700"
          >
             <i class="fa-solid fa-rotate-right text-gray-400"></i>
             <span class="text-[10px] font-bold text-gray-500">+5s</span>
          </button>
          
          <button
            onclick="sendAction('NEXT')"
            class="col-span-4 bg-gradient-to-r from-zinc-800 to-zinc-700 border border-zinc-600 p-4 rounded-2xl flex items-center justify-center gap-3 font-bold shadow-lg active:scale-95 transition"
          >
            <i class="fa-solid fa-forward-step text-white"></i> ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏•‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
          </button>
        </div>

        <div
          id="non-master-msg"
          class="flex-1 flex flex-col items-center justify-center text-zinc-600 border-2 border-dashed border-zinc-800 rounded-2xl p-6 min-h-[120px]"
        >
          <p class="text-sm">‡∏£‡∏≠ Master DJ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏û‡∏•‡∏á</p>
        </div>
      </div>

      <div
        class="shrink-0 p-4 pb-8 pb-safe glass-panel border-t border-white/5 grid grid-cols-2 gap-4"
      >
        <button
          onclick="document.getElementById('queue-modal').classList.remove('hidden')"
          class="bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 p-3 rounded-xl flex items-center justify-center gap-2 font-bold text-sm transition"
        >
          <i class="fa-solid fa-list text-gray-400"></i> ‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á (<span
            id="q-count-btn"
            >0</span
          >)
        </button>
        <button
          id="stop-btn"
          onclick="sendAction('STOP')"
          class="hidden bg-red-900/20 text-red-400 border border-red-900/50 hover:bg-red-900/30 p-3 rounded-xl flex items-center justify-center gap-2 font-bold text-sm transition"
        >
          <i class="fa-solid fa-stop"></i> ‡∏à‡∏ö‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ
        </button>
      </div>
    </div>

    <div
      id="queue-modal"
      class="fixed inset-0 z-[60] bg-black/90 hidden flex items-center justify-center p-4 fade-in"
    >
      <div
        class="bg-zinc-900 border border-zinc-700 w-full max-w-md rounded-2xl flex flex-col max-h-[70vh] shadow-2xl"
      >
        <div
          class="p-4 border-b border-zinc-800 flex justify-between items-center bg-zinc-900 rounded-t-2xl"
        >
          <h3 class="font-bold text-white">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏û‡∏•‡∏á</h3>
          <button
            onclick="document.getElementById('queue-modal').classList.add('hidden')"
            class="text-gray-400 hover:text-white"
          >
            <i class="fa-solid fa-times"></i>
          </button>
        </div>
        <div
          id="queue-list-modal"
          class="overflow-y-auto p-4 space-y-2 bg-black/20"
        ></div>
      </div>
    </div>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const hostId = urlParams.get("host");
      const peerConfig = {
        config: { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] },
      };

      let peer, conn, user;
      let masterId = null;

      window.onload = () => {
        if (!hostId) {
          document.getElementById("error-msg").innerText =
            "‡πÑ‡∏°‡πà‡∏û‡∏ö Host ID (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÉ‡∏´‡∏°‡πà)";
          return;
        }
        const saved = localStorage.getItem(`nj_user_${hostId}`);
        if (saved) {
          const u = JSON.parse(saved);
          document.getElementById("username-input").value = u.name;
          user = u;
          initPeer();
        }
      };

      function handleJoin() {
        const name = document.getElementById("username-input").value.trim();
        if (!name) return;
        user = { id: crypto.randomUUID(), name: name, isMaster: false };
        localStorage.setItem(`nj_user_${hostId}`, JSON.stringify(user));
        initPeer();
      }

      function initPeer() {
        document.getElementById("login-screen").classList.add("hidden");
        document.getElementById("remote-ui").classList.remove("hidden");

        document.getElementById("user-name").innerText = user.name;
        document.getElementById("user-avatar").innerText =
          user.name[0].toUpperCase();

        peer = new Peer(peerConfig);
        peer.on("open", () => {
          setStatus(
            "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...",
            "text-yellow-500",
            "bg-yellow-500/10",
            "border-yellow-500"
          );
          conn = peer.connect(hostId);

          conn.on("open", () => {
            setStatus(
              "‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå",
              "text-green-500",
              "bg-green-500/10",
              "border-green-500"
            );
            conn.send({ type: "JOIN", user: user });
            conn.send({ type: "GET_STATE" });
          });

          conn.on("data", (data) => {
            if (data.type === "UPDATE_STATE") updateState(data);
          });

          conn.on("close", () =>
            setStatus(
              "‡∏´‡∏•‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠",
              "text-red-500",
              "bg-red-500/10",
              "border-red-500"
            )
          );
        });
      }

      function setStatus(text, textColor, bgColor, borderColor) {
        const b = document.getElementById("status-badge");
        b.innerText = text;
        b.className = `text-[10px] px-2 py-1 rounded-full border ${textColor} ${bgColor} ${borderColor}`;
      }

      function updateState(data) {
        masterId = data.masterId;
        const isMaster = user.id === masterId;

        if (isMaster) {
          document.getElementById("master-controls").classList.remove("hidden");
          document.getElementById("non-master-msg").classList.add("hidden");
          document.getElementById("stop-btn").classList.remove("hidden");
          document.getElementById("user-role").innerText = "üëë DJ MASTER";
          document.getElementById("user-role").classList.add("text-pink-500");
        } else {
          document.getElementById("master-controls").classList.add("hidden");
          document.getElementById("non-master-msg").classList.remove("hidden");
          document.getElementById("stop-btn").classList.add("hidden");
          document.getElementById("user-role").innerText = "‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô";
          document
            .getElementById("user-role")
            .classList.remove("text-pink-500");
        }

        document.getElementById("q-count-btn").innerText = data.queue.length;
        const qList = document.getElementById("queue-list-modal");
        if (data.queue.length === 0) {
          qList.innerHTML =
            '<div class="text-center text-zinc-600 text-xs py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏û‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß</div>';
        } else {
          qList.innerHTML = data.queue
            .map(
              (s, i) => `
                    <div class="flex gap-3 items-center p-3 bg-zinc-800/30 rounded border border-white/5">
                        <span class="text-zinc-500 font-mono text-xs w-4 text-center">${
                          i + 1
                        }</span>
                        <img src="${
                          s.thumbnail
                        }" class="w-10 h-10 rounded object-cover opacity-80 bg-zinc-800">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-white truncate">${
                              s.title
                            }</div>
                            <div class="text-xs text-zinc-500">‡πÇ‡∏î‡∏¢ ${
                              s.sender
                            }</div>
                        </div>
                    </div>
                `
            )
            .join("");
        }
      }

      // Updated to support data payload
      function sendAction(type, data = {}) {
        if (conn && conn.open) conn.send({ type, user, ...data });
      }

      function addSong() {
        const url = document.getElementById("url-input").value;
        if (!url) return;
        conn.send({ type: "ADD_SONG", url, user });
        document.getElementById("url-input").value = "";
        document.getElementById("preview-box").classList.add("hidden");
        document.getElementById("add-btn").disabled = true;
        document.getElementById("add-btn").className =
          "w-12 flex items-center justify-center rounded-xl bg-zinc-800 border border-zinc-700 text-gray-500 transition-colors";

        showToast("‡∏™‡πà‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß!");
      }

      const inp = document.getElementById("url-input");
      inp.addEventListener("input", (e) => {
        const val = e.target.value;
        if (val.includes("youtu")) {
          fetch(`https://noembed.com/embed?url=${val}`)
            .then((r) => r.json())
            .then((d) => {
              if (d.title) {
                document
                  .getElementById("preview-box")
                  .classList.remove("hidden");
                document.getElementById("prev-img").src = d.thumbnail_url;
                document.getElementById("prev-title").innerText = d.title;

                const btn = document.getElementById("add-btn");
                btn.disabled = false;
                btn.className =
                  "w-12 flex items-center justify-center rounded-xl bg-pink-600 text-white shadow-lg shadow-pink-600/20 transition-colors";
              }
            });
        } else {
          document.getElementById("preview-box").classList.add("hidden");
        }
      });

      function showToast(msg) {
        const t = document.getElementById("toast");
        document.getElementById("toast-msg").innerText = msg;
        t.classList.remove("opacity-0");
        setTimeout(() => t.classList.add("opacity-0"), 2000);
      }
    </script>
  </body>
</html>